<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Premier League – Sport Adatvizualizáció</title>

  <!-- Vega-Lite -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <!-- CSV beolvasás (6. diagramhoz) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f2f4f8;
      margin: 0;
      padding: 40px 0;
      text-align: center;
      color: #333;
    }

    h1 {
      font-size: 30px;
      font-weight: 600;
      margin-bottom: 25px;
      color: #1a3d7c;
    }

    h2 {
      margin-bottom: 15px;
      color: #1a355e;
      font-size: 22px;
    }

    .chart-card {
      background: white;
      width: 80%;
      margin: 35px auto;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.05);
      text-align: left;
    }

    .chart-container {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      text-align: center;
    }

    .vega-embed canvas,
    .vega-embed svg {
      max-width: 100% !important;
    }

    .note {
      font-size: 13px;
      color: #5a6b85;
      margin-top: 10px;
      line-height: 1.35;
      text-align: center;
    }

    .warn {
      font-size: 13px;
      color: #a33636;
      margin-top: 10px;
      line-height: 1.35;
      text-align: center;
    }
  </style>
</head>

<body>

  <h1>Premier League – Erling Haaland Elemzés</h1>

  <!-- 1 -->
  <div class="chart-card">
    <h2>1. Oszlopdiagram – Haaland gólok (Matchweek 1–11)</h2>
    <div id="chart1" class="chart-container"></div>
  </div>

  <!-- 2 -->
  <div class="chart-card">
    <h2>2. Vonaldiagram – Haaland xG alakulása</h2>
    <div id="chart2" class="chart-container"></div>
  </div>

  <!-- 3 -->
  <div class="chart-card">
    <h2>3. Kördiagram – Manchester City gólmegoszlása</h2>
    <div id="chart3" class="chart-container"></div>
  </div>

  <!-- 4 -->
  <div class="chart-card">
    <h2>4. Pontdiagram – Manchester City játékosok életkora posztok szerint (API)</h2>
    <div id="chart4" class="chart-container"></div>
    <div id="chart4note" class="note"></div>
  </div>

  <!-- 5 (HOZZÁADVA – a “jó” 5-ös kód) -->
  <div class="chart-card">
    <h2>5. Többdimenziós, interaktív pontdiagram – Manchester City játékosprofilok (API)</h2>
    <div id="chart5" class="chart-container"></div>
    <div id="chart5note" class="note"></div>
    <div id="chart5warn" class="warn"></div>
  </div>

  <!-- 6 (ÚJ – CSV) -->
  <div class="chart-card">
    <h2>6. Interaktív diagram (CSV) – Manchester City 2019 meccs mutató (választható)</h2>
    <div id="chart6" class="chart-container"></div>
    <div id="chart6note" class="note"></div>
    <div id="chart6warn" class="warn"></div>
  </div>

  <!-- ===================== VEGA-LITE SCRIPT (1–3) ===================== -->
  <script>
    const chart1 = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "description": "Haaland goals per matchweek",
      "data": {
        "values": [
          {"Week": 1, "Goals": 2},
          {"Week": 2, "Goals": 0},
          {"Week": 3, "Goals": 1},
          {"Week": 4, "Goals": 2},
          {"Week": 5, "Goals": 1},
          {"Week": 6, "Goals": 2},
          {"Week": 7, "Goals": 1},
          {"Week": 8, "Goals": 2},
          {"Week": 9, "Goals": 0},
          {"Week": 10,"Goals": 2},
          {"Week": 11,"Goals": 0}
        ]
      },
      "mark": "bar",
      "encoding": {
        "x": {"field": "Week", "type": "ordinal", "title": "Matchweek"},
        "y": {"field": "Goals", "type": "quantitative", "title": "Gólok száma"},
        "color": {"value": "#1e88e5"}
      }
    };

    const chart2 = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "description": "Haaland xG trend",
      "data": {
        "values": [
          {"Week": 1, "xG": 0.87},
          {"Week": 2, "xG": 0.80},
          {"Week": 3, "xG": 0.32},
          {"Week": 4, "xG": 0.42},
          {"Week": 5, "xG": 0.43},
          {"Week": 6, "xG": 0.46},
          {"Week": 7, "xG": 0.22},
          {"Week": 8, "xG": 0.18},
          {"Week": 9, "xG": 0.41},
          {"Week": 10,"xG": 0.31},
          {"Week": 11,"xG": 0.05}
        ]
      },
      "mark": {"type": "line", "point": true},
      "encoding": {
        "x": {"field": "Week", "type": "ordinal", "title": "Matchweek"},
        "y": {"field": "xG", "type": "quantitative", "title": "Expected Goals (xG)"},
        "color": {"value": "#e53935"}
      }
    };

    const chart3 = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "description": "Goal share",
      "data": {
        "values": [
          {"Player": "Haaland", "Goals": 11},
          {"Player": "Foden", "Goals": 4},
          {"Player": "Nicolás González", "Goals": 3}
        ]
      },
      "mark": {"type": "arc", "innerRadius": 50},
      "encoding": {
        "theta": {"field": "Goals", "type": "quantitative"},
        "color": {"field": "Player", "type": "nominal"},
        "tooltip": [
          {"field": "Player", "type": "nominal", "title": "Játékos"},
          {"field": "Goals", "type": "quantitative", "title": "Gólok száma"}
        ]
      },
      "view": {"stroke": null}
    };

    vegaEmbed("#chart1", chart1, { actions: false });
    vegaEmbed("#chart2", chart2, { actions: false });
    vegaEmbed("#chart3", chart3, { actions: false });
  </script>

  <!-- ===================== VEGA-LITE SCRIPT (4 – Manchester City + API) ===================== -->
  <script>
    (async () => {
      const note = document.getElementById("chart4note");

      function calcAge(dateStr) {
        if (!dateStr) return null;
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return null;

        const now = new Date();
        let age = now.getFullYear() - d.getFullYear();
        const m = now.getMonth() - d.getMonth();
        if (m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
        return age;
      }

      function normalizePos(pos) {
        const p = (pos || "").toLowerCase();
        if (p.includes("goalkeeper") || p.includes("keeper") || p.includes("gk")) return "GKP";
        if (p.includes("def") || p.includes("back")) return "DEF";
        if (p.includes("mid")) return "MID";
        if (p.includes("forw") || p.includes("striker") || p.includes("wing")) return "FWD";
        return "Egyéb";
      }

      try {
        const url = "https://www.thesportsdb.com/api/v1/json/3/searchplayers.php?t=Manchester%20City";
        const res = await fetch(url);
        if (!res.ok) throw new Error("API HTTP hiba: " + res.status);

        const apiData = await res.json();
        const playersRaw = apiData.player || [];

        const values = playersRaw
          .map(p => {
            const age = calcAge(p.dateBorn);
            return {
              Player: p.strPlayer || "Ismeretlen",
              Position: normalizePos(p.strPosition),
              Age: age,
              Nationality: p.strNationality || "Ismeretlen",
              Born: p.dateBorn || ""
            };
          })
          .filter(d => Number.isFinite(d.Age) && d.Age >= 15 && d.Age <= 45);

        if (values.length === 0) {
          note.textContent = "Nem érkezett elég értelmezhető játékosadat (születési dátum hiányozhat az API-ban).";
          return;
        }

        const chart4 = {
          "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
          "description": "Manchester City játékosok életkora poszt szerint (TheSportsDB API)",
          "data": { "values": values },
          "width": 780,
          "height": 360,
          "mark": { "type": "circle", "opacity": 0.85, "size": 120 },
          "encoding": {
            "x": {
              "field": "Position",
              "type": "nominal",
              "title": "Poszt (egyszerűsítve)",
              "sort": ["GKP", "DEF", "MID", "FWD", "Egyéb"]
            },
            "y": {
              "field": "Age",
              "type": "quantitative",
              "title": "Életkor (év)",
              "scale": { "zero": false }
            },
            "tooltip": [
              { "field": "Player", "type": "nominal", "title": "Játékos" },
              { "field": "Position", "type": "nominal", "title": "Poszt" },
              { "field": "Age", "type": "quantitative", "title": "Életkor" },
              { "field": "Nationality", "type": "nominal", "title": "Nemzetiség" },
              { "field": "Born", "type": "nominal", "title": "Születési dátum" }
            ]
          },
          "config": {
            "view": { "stroke": null },
            "axis": { "labelFontSize": 12, "titleFontSize": 13 }
          }
        };

        await vegaEmbed("#chart4", chart4, { actions: false });

        note.innerHTML =
          "Adatforrás: TheSportsDB (külső, ingyenes publikus API – Manchester City játékosok).<br>" +
          "Mit mutat? A pontok a játékosok, Y tengely az életkor, X tengely a poszt.";
      } catch (err) {
        console.error("Chart4 hiba:", err);
        note.textContent =
          "Az API-adat betöltése nem sikerült (F12 → Console). A többi diagram ettől függetlenül működik.";
      }
    })();
  </script>

  <!-- ===================== VEGA-LITE SCRIPT (5 – a “jó” interaktív, többdimenziós) ===================== -->
  <script>
    (async () => {
      const note = document.getElementById("chart5note");
      const warn = document.getElementById("chart5warn");

      const TEAM_ID = 133613; // Manchester City (TheSportsDB)
      const apiUrl = `https://www.thesportsdb.com/api/v1/json/3/lookup_all_players.php?id=${TEAM_ID}`;

      function parseHeightCm(str) {
        if (!str) return null;
        const s = String(str).trim();

        let m = s.match(/(\d+(?:[.,]\d+)?)\s*m/i);
        if (m) {
          const val = parseFloat(m[1].replace(",", "."));
          if (Number.isFinite(val)) return Math.round(val * 100);
        }

        let cm = s.match(/(\d+)\s*cm/i);
        if (cm) {
          const val = parseInt(cm[1], 10);
          if (Number.isFinite(val)) return val;
        }

        let fi = s.match(/(\d+)\s*'\s*(\d+)?/);
        if (fi) {
          const feet = parseInt(fi[1], 10);
          const inch = fi[2] ? parseInt(fi[2], 10) : 0;
          if (Number.isFinite(feet) && Number.isFinite(inch)) {
            const totalIn = feet * 12 + inch;
            return Math.round(totalIn * 2.54);
          }
        }

        const justNum = s.match(/^(\d+(?:[.,]\d+)?)$/);
        if (justNum) {
          const val = parseFloat(justNum[1].replace(",", "."));
          if (!Number.isFinite(val)) return null;
          if (val >= 1.5 && val <= 2.2) return Math.round(val * 100);
          if (val >= 140 && val <= 230) return Math.round(val);
        }

        return null;
      }

      function parseWeightKg(str) {
        if (!str) return null;
        const s = String(str).trim();

        let kg = s.match(/(\d+(?:[.,]\d+)?)\s*kg/i);
        if (kg) {
          const val = parseFloat(kg[1].replace(",", "."));
          if (Number.isFinite(val)) return Math.round(val);
        }

        let lbs = s.match(/(\d+(?:[.,]\d+)?)\s*lb/i);
        if (lbs) {
          const val = parseFloat(lbs[1].replace(",", "."));
          if (Number.isFinite(val)) return Math.round(val * 0.453592);
        }

        const justNum = s.match(/^(\d+(?:[.,]\d+)?)$/);
        if (justNum) {
          const val = parseFloat(justNum[1].replace(",", "."));
          if (!Number.isFinite(val)) return null;
          if (val >= 40 && val <= 140) return Math.round(val);
        }

        return null;
      }

      function calcAge(born) {
        if (!born) return null;
        const d = new Date(born);
        if (isNaN(d.getTime())) return null;
        const now = new Date();
        let age = now.getFullYear() - d.getFullYear();
        const m = now.getMonth() - d.getMonth();
        if (m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
        return age;
      }

      function normalizePosition(pos) {
        const p = (pos || "").toLowerCase();
        if (p.includes("goal") || p.includes("keeper") || p === "gk") return "Kapus";
        if (p.includes("def") || p.includes("back") || p.includes("centre-back") || p.includes("center-back")) return "Védő";
        if (p.includes("mid")) return "Középpályás";
        if (p.includes("forw") || p.includes("striker") || p.includes("wing") || p.includes("forward")) return "Támadó";
        if (!pos) return "Ismeretlen";
        return "Egyéb";
      }

      try {
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error("API HTTP hiba: " + res.status);
        const json = await res.json();

        const playersRaw = (json && json.player) ? json.player : [];

        const cleaned = playersRaw.map(p => {
          const heightCm = parseHeightCm(p.strHeight);
          const weightKg = parseWeightKg(p.strWeight);
          const age = calcAge(p.dateBorn);

          const weightMissing = !(Number.isFinite(weightKg));
          const weightImputed = Number.isFinite(weightKg) ? weightKg : 78;

          return {
            name: p.strPlayer || "Ismeretlen",
            position: normalizePosition(p.strPosition),
            nationality: p.strNationality || "Ismeretlen",
            born: p.dateBorn || null,
            age: age,
            height_cm: heightCm,
            weight_kg: weightKg,
            weight_kg_imputed: weightImputed,
            weight_missing: weightMissing ? "Hiányzik" : "Van"
          };
        });

        const players = cleaned
          .filter(d => Number.isFinite(d.age) && Number.isFinite(d.height_cm))
          .filter(d => d.age >= 16 && d.age <= 45)
          .filter(d => d.height_cm >= 155 && d.height_cm <= 210);

        if (players.length === 0) {
          warn.textContent =
            "Az API most nem adott olyan játékosokat, ahol van születési dátum ÉS magasság. Próbáld később.";
          note.textContent = "";
          return;
        }

        const missingWeightCount = players.filter(p => p.weight_missing === "Hiányzik").length;

        note.innerHTML =
          "Adatforrás: TheSportsDB (ingyenes publikus API) – Manchester City játékoslista (team id).<br>" +
          "Interakció: csúszkákkal szűrheted az életkort és a magasságot; legend kattintás poszt szűrés.<br>" +
          "Dimenziók: X = életkor, Y = magasság, buborék méret = súly, szín = poszt.";

        warn.textContent = missingWeightCount > 0
          ? `Figyelem: ${missingWeightCount} játékosnál hiányzott a súly az API-ból, ezért becsült méretet kapott.`
          : "";

        const chart5 = {
          "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
          "description": "Manchester City játékosprofilok: életkor vs magasság; méret = súly; szín = poszt; interaktív szűrés.",
          "data": { "values": players },

          "width": 860,
          "height": 450,

          "params": [
            { "name": "ageMin", "value": 18, "bind": { "input": "range", "min": 16, "max": 40, "step": 1, "name": "Min életkor: " } },
            { "name": "ageMax", "value": 35, "bind": { "input": "range", "min": 16, "max": 45, "step": 1, "name": "Max életkor: " } },
            { "name": "hMin", "value": 165, "bind": { "input": "range", "min": 155, "max": 205, "step": 1, "name": "Min magasság (cm): " } },
            { "name": "hMax", "value": 198, "bind": { "input": "range", "min": 155, "max": 210, "step": 1, "name": "Max magasság (cm): " } }
          ],

          "transform": [
            { "filter": "datum.age >= ageMin && datum.age <= ageMax" },
            { "filter": "datum.height_cm >= hMin && datum.height_cm <= hMax" }
          ],

          "mark": { "type": "circle", "opacity": 0.88 },

          "encoding": {
            "x": { "field": "age", "type": "quantitative", "title": "Életkor (év)", "axis": { "tickMinStep": 1 } },
            "y": { "field": "height_cm", "type": "quantitative", "title": "Magasság (cm)" },
            "size": { "field": "weight_kg_imputed", "type": "quantitative", "title": "Súly (kg) – méret" },
            "color": { "field": "position", "type": "nominal", "title": "Poszt" },
            "shape": { "field": "weight_missing", "type": "nominal", "title": "Súly adat" },
            "tooltip": [
              { "field": "name", "type": "nominal", "title": "Játékos" },
              { "field": "position", "type": "nominal", "title": "Poszt" },
              { "field": "nationality", "type": "nominal", "title": "Nemzetiség" },
              { "field": "age", "type": "quantitative", "title": "Életkor" },
              { "field": "height_cm", "type": "quantitative", "title": "Magasság (cm)" },
              { "field": "weight_kg", "type": "quantitative", "title": "Súly (kg) – eredeti" }
            ]
          },

          "config": {
            "view": { "stroke": null },
            "axis": { "labelFontSize": 12, "titleFontSize": 13 },
            "legend": { "labelFontSize": 12, "titleFontSize": 12 }
          }
        };

        await vegaEmbed("#chart5", chart5, { actions: false });

      } catch (err) {
        console.error("Chart5 API hiba:", err);
        note.textContent =
          "Az API-adat betöltése nem sikerült. Ha file://-ból futtatod, válts Live Server-re vagy GitHub Pages-re.";
        warn.textContent =
          "Ha Live Serveren sem jó: F12 → Console / Network nézd meg a hibát (CORS/404).";
      }
    })();
  </script>

  <!-- ===================== 6 – CSV (EGYSZERŰEN, BIZTOSAN) ===================== -->
  <script>
    (async () => {
      const note = document.getElementById("chart6note");
      const warn = document.getElementById("chart6warn");

      // EZT AZ ÚTVONALAT HASZNÁLOD A REPÓBAN:
      // data/Manchester City_2019_season data.csv
      const csvUrl = "data/Manchester City_2019_season data.csv";

      function normalizeResult(r) {
        const s = String(r || "").trim().toLowerCase();
        if (s === "w") return "Győzelem (W)";
        if (s === "d") return "Döntetlen (D)";
        if (s === "l") return "Vereség (L)";
        return "Ismeretlen";
      }

      try {
        const res = await fetch(csvUrl);
        if (!res.ok) throw new Error("CSV HTTP hiba: " + res.status);
        const csvText = await res.text();

        const parsed = Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true
        });

        const rows = parsed.data || [];
        if (!rows.length) {
          warn.textContent = "A CSV üres vagy nem sikerült beolvasni.";
          return;
        }

        // Biztos oszlopok: result + xG + xGA (ezek vannak a példádban)
        // Ha valamiért az egyik hiányzik, jelzünk.
        if (!("result" in rows[0]) || !("xG" in rows[0]) || !("xGA" in rows[0])) {
          warn.textContent =
            "A CSV bejött, de nem találom a várt oszlopokat: result, xG, xGA. Ellenőrizd a fájl fejlécét!";
          return;
        }

        const data = rows
          .map(r => ({
            GW: Number(r.GW),
            Result: normalizeResult(r.result),
            xG: Number(r.xG),
            xGA: Number(r.xGA),
            npxGD: ("npxGD" in r) ? Number(r.npxGD) : null
          }))
          .filter(d =>
            Number.isFinite(d.GW) &&
            Number.isFinite(d.xG) &&
            Number.isFinite(d.xGA)
          );

        if (data.length === 0) {
          warn.textContent = "Nem maradt elég tiszta sor (xG/xGA számok hiányozhatnak).";
          return;
        }

        // 6. diagram: interaktív (dropdown) – választható mutató: xG vagy xGA (és ha van: npxGD)
        const metricOptions = ["xG", "xGA"].concat(data.some(d => Number.isFinite(d.npxGD)) ? ["npxGD"] : []);

        const metricLabels = {
          xG: "xG (támadó helyzetminőség)",
          xGA: "xGA (kapott helyzetminőség)",
          npxGD: "npxGD (npxG - npxGA)"
        };

        const chart6 = {
          "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
          "description": "Manchester City 2019 – választott mutató időben (CSV, interaktív)",
          "data": { "values": data },
          "width": 860,
          "height": 360,

          "params": [
            {
              "name": "metric",
              "value": metricOptions[0],
              "bind": {
                "input": "select",
                "name": "Mutató: ",
                "options": metricOptions,
                "labels": metricOptions.map(m => metricLabels[m] || m)
              }
            }
          ],

          "layer": [
            {
              "mark": { "type": "line", "point": true },
              "encoding": {
                "x": { "field": "GW", "type": "quantitative", "title": "Forduló (GW)", "axis": { "tickMinStep": 1 } },
                "y": { "field": { "expr": "datum[metric]" }, "type": "quantitative", "title": "Érték" },
                "color": { "field": "Result", "type": "nominal", "title": "Eredmény" },
                "tooltip": [
                  { "field": "GW", "type": "quantitative", "title": "GW" },
                  { "field": "Result", "type": "nominal", "title": "Eredmény" },
                  { "field": "xG", "type": "quantitative", "title": "xG" },
                  { "field": "xGA", "type": "quantitative", "title": "xGA" },
                  { "field": "npxGD", "type": "quantitative", "title": "npxGD" }
                ]
              }
            }
          ],

          "config": {
            "view": { "stroke": null },
            "axis": { "labelFontSize": 12, "titleFontSize": 13 }
          }
        };

        await vegaEmbed("#chart6", chart6, { actions: false });

        note.innerHTML =
          "Adatforrás: saját CSV a repóban: <b>" + csvUrl + "</b>.<br>" +
          "Mit mutat? A kiválasztott mutató (xG / xGA / npxGD) alakulását fordulónként. A szín az eredményt jelöli (W/D/L).";
        warn.textContent = "";

      } catch (err) {
        console.error("Chart6 CSV hiba:", err);
        warn.textContent =
          "A CSV betöltése nem sikerült. Fontos: ne file://-ból futtasd, hanem Live Server / GitHub Pages!";
        note.textContent = "";
      }
    })();
  </script>

</body>
</html>
